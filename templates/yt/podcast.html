{% extends "base.html" %}

{% block title %}Podcast Studio · WatchUp{% endblock %}

{% block content %}
  <section class="page-hero">
    <h1>Podcast Studio</h1>
    <p class="page-subtitle">Transform text into scripts and audio in guided steps.</p>
  </section>

  <a class="text-link" href="{{ url_for('yt.index') }}">⬅ Back to Dashboard</a>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="flash-list">
        {% for category, message in messages %}
          <p class="flash flash-{{ category }}">{{ message }}</p>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  {% set selected_script_prompt = manifest.selected_script_prompt_name if manifest else '' %}
  {% set selected_audio_prompt = manifest.selected_audio_prompt_name if manifest else '' %}
  {% set selected_tone = manifest.selected_tone if manifest else tone_options[0] %}
  {% set selected_voice = manifest.selected_voice if manifest else voice_options[0] %}
  {% set selected_script_model = manifest.selected_script_model if manifest and manifest.selected_script_model else 'gpt-4o-mini' %}

  <p class="step-indicator"><strong>Step {{ current_step }} of 7</strong></p>

  {% if current_step == 1 %}
    <section class="card">
      <form method="post" enctype="multipart/form-data">
        <input type="hidden" name="action" value="start">
        <label>Step 1: Upload text files (.txt or .md):</label>
        <input type="file" name="files" accept=".txt,.md" multiple required>
        <label class="checkbox-row">
          <input type="checkbox" name="skip_script" {% if skip_script_checked %}checked{% endif %}>
          Skip script generation (use uploaded text as-is)
        </label>
        <label class="checkbox-row">
          <input type="checkbox" name="auto_split" checked>
          Auto-split long text (recommended)
        </label>
        <label>Max chunk size (chars):</label>
        <input type="number" name="max_chars" value="7000" min="3000" max="12000">
        <button class="button button--primary" type="submit">Next: Choose Script Prompt</button>
      </form>
    </section>
  {% endif %}

  {% if current_step == 2 %}
    <section class="card">
      <h2>Step 2: Script Prompt</h2>
      <form method="post">
        <input type="hidden" name="job_id" value="{{ job_id }}">
        <label>Saved script prompts:</label>
        <select name="selected_script_prompt" id="scriptPromptSelect">
          {% for prompt in script_prompts %}
            <option value="{{ prompt.name }}" {% if prompt.name == selected_script_prompt %}selected{% endif %}>
              {{ prompt.name }}
            </option>
          {% endfor %}
        </select>

        <label>Script prompt text:</label>
        <textarea name="script_prompt_text" id="scriptPromptText" rows="10" style="width: 100%;">{% if selected_script_prompt %}{% for prompt in script_prompts %}{% if prompt.name == selected_script_prompt %}{{ prompt.text }}{% endif %}{% endfor %}{% else %}{{ script_prompts[0].text }}{% endif %}</textarea>

        <label>Tone:</label>
        <select name="tone">
          {% for tone in tone_options %}
            <option value="{{ tone }}" {% if tone == selected_tone %}selected{% endif %}>{{ tone }}</option>
          {% endfor %}
        </select>

        <label>Script model:</label>
        <select name="script_model">
          <option value="gpt-4o-mini" {% if selected_script_model == 'gpt-4o-mini' %}selected{% endif %}>gpt-4o-mini</option>
          <option value="gpt-5-mini" {% if selected_script_model == 'gpt-5-mini' %}selected{% endif %}>gpt-5-mini</option>
        </select>
        <small>Note: gpt-5-mini ~1.67x input cost, ~3.33x output cost vs gpt-4o-mini.</small>

        <label>Save prompt as:</label>
        <input type="text" name="prompt_name" placeholder="Prompt name">

        <input type="hidden" name="prompt_action" id="scriptPromptAction" value="">
        <div class="button-row">
          <button class="button button--ghost" type="submit" name="action" value="save_script_prompt" data-prompt-action="save_new">Save as new</button>
          <button class="button button--ghost" type="submit" name="action" value="save_script_prompt" data-prompt-action="overwrite">Overwrite selected</button>
          <button class="button button--ghost" type="submit" name="action" value="save_script_prompt" data-prompt-action="delete">Delete selected</button>
        </div>
        <hr>
        <button class="button button--primary" type="submit" name="action" value="generate_scripts">Next: Generate scripts</button>
      </form>
    </section>
  {% endif %}

  {% if current_step == 3 %}
    <section class="card">
      <h2>Step 3: Script Generation</h2>
      <p>Job started. This page will update automatically.</p>
      <div id="jobStatusPanel" class="status-panel">
        <p><strong>Status:</strong> <span id="jobState">{{ job_status.state if job_status else 'queued' }}</span></p>
        <p><strong>Current file:</strong> <span id="jobFile">{{ job_status.current_file if job_status else '' }}</span></p>
        <p><strong>Chunk:</strong> <span id="jobChunk">{{ job_status.current_chunk if job_status else 0 }}</span> / <span id="jobTotalChunks">{{ job_status.total_chunks if job_status else 0 }}</span></p>
        <p><strong>Last message:</strong> <span id="jobMessage">{{ job_status.last_message if job_status else '' }}</span></p>
      </div>
      <div id="jobErrors" style="display: none;">
        <h3>Errors</h3>
        <ul id="jobErrorList"></ul>
      </div>
      <div id="jobComplete" style="display: none;">
        {% if job_id %}
          <a href="{{ url_for('yt.podcast', job_id=job_id) }}">View scripts</a>
        {% endif %}
      </div>
    </section>
  {% endif %}

  {% if current_step == 4 %}
    <section class="card">
      <h2>Step 4: Scripts</h2>
      {% if manifest and manifest.script_files %}
        <ul class="list-stack">
          {% for item in manifest.script_files %}
            <li>
              <strong>{{ item.original_name }}</strong>
              <div class="link-row">
                <a href="{{ url_for('yt.podcast_download', category='scripts', filename=item.script_full_filename) }}">Download Full Script</a>
              </div>
              {% if item.script_parts %}
                <ul>
                  {% for part in item.script_parts %}
                    <li>
                      <a href="{{ url_for('yt.podcast_download', category='scripts', filename=part.script_filename) }}">Part {{ loop.index }}</a>
                    </li>
                  {% endfor %}
                </ul>
              {% endif %}
              <p class="meta-text">
                Chunks: {{ item.chunk_count }} |
                Auto-split: {{ 'Yes' if item.auto_split else 'No' }} |
                Headings detected: {{ 'Yes' if item.headings_detected else 'No' }} |
                Headings used: {{ 'Yes' if item.headings_used else 'No' }} |
                Skip script: {{ 'Yes' if item.script_skipped else 'No' }}
                {% if not item.script_skipped %}
                  | Script model: {{ item.script_model }}
                {% endif %}
              </p>
            </li>
          {% endfor %}
        </ul>
      {% endif %}
      {% if job_id %}
        <a class="button button--primary" href="{{ url_for('yt.podcast', job_id=job_id, step='audio') }}">Next: Audio stage</a>
      {% endif %}
    </section>
  {% endif %}

  {% if current_step == 5 %}
    <section class="card">
      <h2>Step 5: Audio Prompt</h2>
      <form method="post">
        <input type="hidden" name="job_id" value="{{ job_id }}">
        <label>Saved audio prompts:</label>
        <select name="selected_audio_prompt" id="audioPromptSelect">
          {% for prompt in audio_prompts %}
            <option value="{{ prompt.name }}" {% if prompt.name == selected_audio_prompt %}selected{% endif %}>
              {{ prompt.name }}
            </option>
          {% endfor %}
        </select>

        <label>Audio prompt text:</label>
        <textarea name="audio_prompt_text" id="audioPromptText" rows="8" style="width: 100%;">{% if selected_audio_prompt %}{% for prompt in audio_prompts %}{% if prompt.name == selected_audio_prompt %}{{ prompt.text }}{% endif %}{% endfor %}{% else %}{{ audio_prompts[0].text }}{% endif %}</textarea>

        <label>Voice:</label>
        <select name="voice">
          {% for voice in voice_options %}
            <option value="{{ voice }}" {% if voice == selected_voice %}selected{% endif %}>{{ voice }}</option>
          {% endfor %}
        </select>

        <label>Save prompt as:</label>
        <input type="text" name="prompt_name" placeholder="Prompt name">

        <input type="hidden" name="prompt_action" id="audioPromptAction" value="">
        <div class="button-row">
          <button class="button button--ghost" type="submit" name="action" value="save_audio_prompt" data-prompt-action="save_new">Save as new</button>
          <button class="button button--ghost" type="submit" name="action" value="save_audio_prompt" data-prompt-action="overwrite">Overwrite selected</button>
          <button class="button button--ghost" type="submit" name="action" value="save_audio_prompt" data-prompt-action="delete">Delete selected</button>
        </div>
        <hr>
        <button class="button button--primary" type="submit" name="action" value="generate_audio">Generate audio</button>
      </form>
    </section>
  {% endif %}

  {% if current_step == 7 %}
    <section class="card">
      <h2>Step 7: Audio Results</h2>
      {% if manifest and manifest.audio_files %}
        {% for item in manifest.audio_files %}
          <div class="card card--nested">
            <h3>{{ item.original_name }}</h3>
            {% if item.audio_full_filename %}
              <p>
                <a href="{{ url_for('yt.podcast_download', category='audio', filename=item.audio_full_filename) }}">Download Full Audio</a>
              </p>
              <audio controls preload="none" style="width: 100%; max-width: 500px;">
                <source src="{{ url_for('yt.podcast_media', filename=item.audio_full_filename) }}" type="audio/mpeg">
                Your browser does not support the audio element.
              </audio>
            {% else %}
              <p>Audio merge failed; download parts below:</p>
              <ul>
                {% for part in item.audio_parts %}
                  <li>
                    <a href="{{ url_for('yt.podcast_download', category='audio', filename=part.audio_filename) }}">Part {{ loop.index }}</a>
                  </li>
                {% endfor %}
              </ul>
            {% endif %}
            <p class="meta-text">
              Chunks: {{ item.chunk_count }} |
              Auto-split: {{ 'Yes' if item.auto_split else 'No' }} |
              Headings detected: {{ 'Yes' if item.headings_detected else 'No' }} |
              Headings used: {{ 'Yes' if item.headings_used else 'No' }} |
              Skip script: {{ 'Yes' if item.script_skipped else 'No' }}
              {% if not item.script_skipped %}
                | Script model: {{ item.script_model }}
              {% endif %}
            </p>
          </div>
        {% endfor %}
      {% endif %}
      {% if job_id %}
        <h3>Open job folders</h3>
        <ul class="list-stack">
          <li><a href="{{ url_for('yt.open_folder', job_id=job_id, kind='uploads') }}">Open uploads folder</a></li>
          <li><a href="{{ url_for('yt.open_folder', job_id=job_id, kind='scripts') }}">Open scripts folder</a></li>
          <li><a href="{{ url_for('yt.open_folder', job_id=job_id, kind='audio') }}">Open audio folder</a></li>
        </ul>
        <h4>Open on your computer (SMB)</h4>
        <ul class="list-stack">
          <li><a href="{{ smb_base_url }}/inputs/" target="_blank" rel="noopener">Open inputs folder</a></li>
          <li><a href="{{ smb_base_url }}/scripts/{{ job_id }}/" target="_blank" rel="noopener">Open scripts folder</a></li>
          <li><a href="{{ smb_base_url }}/audio/{{ job_id }}/" target="_blank" rel="noopener">Open audio folder</a></li>
        </ul>
      {% endif %}
    </section>
  {% endif %}

  {% if errors %}
    <section class="card">
      <h2>Errors</h2>
      <ul>
        {% for err in errors %}
          <li><strong>{{ err.file }}:</strong> {{ err.error }}</li>
        {% endfor %}
      </ul>
    </section>
  {% endif %}

  <script>
    const scriptPrompts = {{ script_prompts | tojson }};
    const audioPrompts = {{ audio_prompts | tojson }};
    const jobId = {{ job_id | tojson }};

    function updatePromptText(selectId, textareaId, prompts) {
      const select = document.getElementById(selectId);
      const textarea = document.getElementById(textareaId);
      if (!select || !textarea) return;
      const selected = prompts.find((prompt) => prompt.name === select.value);
      if (selected) {
        textarea.value = selected.text;
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      const scriptSelect = document.getElementById("scriptPromptSelect");
      const audioSelect = document.getElementById("audioPromptSelect");
      if (scriptSelect) {
        scriptSelect.addEventListener("change", () => updatePromptText("scriptPromptSelect", "scriptPromptText", scriptPrompts));
      }
      if (audioSelect) {
        audioSelect.addEventListener("change", () => updatePromptText("audioPromptSelect", "audioPromptText", audioPrompts));
      }

      document.querySelectorAll("button[data-prompt-action]").forEach((button) => {
        button.addEventListener("click", () => {
          const hiddenInputId = button.value === "save_script_prompt" ? "scriptPromptAction" : "audioPromptAction";
          const hiddenInput = document.getElementById(hiddenInputId);
          if (hiddenInput) {
            hiddenInput.value = button.dataset.promptAction;
          }
        });
      });

      if (jobId && document.getElementById("jobStatusPanel")) {
        const stateEl = document.getElementById("jobState");
        const fileEl = document.getElementById("jobFile");
        const chunkEl = document.getElementById("jobChunk");
        const totalEl = document.getElementById("jobTotalChunks");
        const msgEl = document.getElementById("jobMessage");
        const errorsBox = document.getElementById("jobErrors");
        const errorList = document.getElementById("jobErrorList");
        const completeBox = document.getElementById("jobComplete");

        const updateErrors = (errors) => {
          if (!errors || errors.length === 0) {
            errorsBox.style.display = "none";
            return;
          }
          errorList.innerHTML = "";
          errors.forEach((err) => {
            const li = document.createElement("li");
            li.textContent = `${err.file}: ${err.error}`;
            errorList.appendChild(li);
          });
          errorsBox.style.display = "block";
        };

        const pollStatus = () => {
          fetch(`/job/${jobId}/status`)
            .then((response) => response.json())
            .then((data) => {
              stateEl.textContent = data.state || "";
              fileEl.textContent = data.current_file || "";
              chunkEl.textContent = data.current_chunk ?? 0;
              totalEl.textContent = data.total_chunks ?? 0;
              msgEl.textContent = data.last_message || "";
              updateErrors(data.errors || []);
              if (data.state === "done") {
                completeBox.style.display = "block";
              }
            })
            .catch(() => {});
        };

        pollStatus();
        setInterval(pollStatus, 1500);
      }
    });
  </script>
{% endblock %}
